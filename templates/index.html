<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gate Count Query Interface</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f5f5;
      }
      .container {
        background: white;
        padding: 30px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      h1 {
        color: #333;
        text-align: center;
        margin-bottom: 30px;
      }
      .form-group {
        margin-bottom: 20px;
      }
      label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
        color: #555;
      }
      select,
      input[type="date"] {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 16px;
      }
      .date-range {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
      }
      .button-group {
        display: flex;
        gap: 10px;
        margin-top: 20px;
      }
      button {
        padding: 12px 24px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
        font-weight: bold;
      }
      .btn-primary {
        background-color: #007bff;
        color: white;
      }
      .btn-primary:hover {
        background-color: #0056b3;
      }
      .btn-secondary {
        background-color: #28a745;
        color: white;
      }
      .btn-secondary:hover {
        background-color: #1e7e34;
      }
      .btn-secondary:disabled {
        background-color: #6c757d;
        cursor: not-allowed;
      }
      .loading {
        text-align: center;
        margin: 20px 0;
        color: #666;
      }
      .error {
        background-color: #f8d7da;
        color: #721c24;
        padding: 12px;
        border-radius: 4px;
        margin: 20px 0;
      }
      .results-info {
        margin: 20px 0;
        padding: 10px;
        background-color: #d4edda;
        color: #155724;
        border-radius: 4px;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
        background: white;
      }
      th,
      td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #ddd;
      }
      th {
        background-color: #f8f9fa;
        font-weight: bold;
        color: #495057;
      }
      tr:hover {
        background-color: #f5f5f5;
      }
      .table-container {
        max-height: 600px;
        overflow-y: auto;
        border: 1px solid #ddd;
        border-radius: 4px;
      }
      .chart-container {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        margin-bottom: 30px;
      }
      .chart-wrapper {
        position: relative;
        height: 300px;
        margin-top: 20px;
      }
      .stats-container {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        margin-bottom: 30px;
      }
      .stats-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 30px;
        margin-top: 20px;
      }
      .stat-item {
        text-align: center;
        padding: 20px;
        border-radius: 6px;
        border: 2px solid #e9ecef;
      }
      .stat-number {
        font-size: 2.5em;
        font-weight: bold;
        margin-bottom: 10px;
        color: #495057;
      }
      .stat-label {
        font-size: 1.1em;
        color: #6c757d;
        font-weight: 500;
      }
      .entrances {
        border-color: #28a745;
        background-color: #f8fff9;
      }
      .entrances .stat-number {
        color: #28a745;
      }
      .exits {
        border-color: #dc3545;
        background-color: #fff8f8;
      }
      .exits .stat-number {
        color: #dc3545;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Gate Count Query Interface</h1>
      
      <div class="chart-container">
        <h2>Monthly Entrances - Past Year</h2>
        <div class="chart-wrapper">
          <canvas id="monthlyChart"></canvas>
        </div>
      </div>

      <div class="stats-container">
        <h2>Past 3 Hours Activity</h2>
        <div class="stats-grid">
          <div class="stat-item entrances">
            <div class="stat-number" id="entrancesCount">--</div>
            <div class="stat-label">People Entered</div>
          </div>
          <div class="stat-item exits">
            <div class="stat-number" id="exitsCount">--</div>
            <div class="stat-label">People Exited</div>
          </div>
        </div>
      </div>

      <form id="queryForm">
        <div class="form-group">
          <label for="gate_name">Gate Name:</label>
          <select id="gate_name" name="gate_name">
            <option value="all">All Gates</option>
            {{range .GateNames}}
            <option value="{{.}}">{{.}}</option>
            {{end}}
          </select>
        </div>

        <div class="date-range">
          <div class="form-group">
            <label for="start_date">Start Date:</label>
            <input type="date" id="start_date" name="start_date" />
          </div>

          <div class="form-group">
            <label for="end_date">End Date:</label>
            <input type="date" id="end_date" name="end_date" />
          </div>
        </div>

        <div class="form-group">
          <label for="order_by">Sort Order:</label>
          <select id="order_by" name="order_by">
            <option value="asc">Oldest First (ASC)</option>
            <option value="desc">Newest First (DESC)</option>
          </select>
        </div>

        <div class="button-group">
          <button type="submit" class="btn-primary">Query Data</button>
          <button type="button" id="downloadCsv" class="btn-secondary" disabled>
            Download CSV
          </button>
        </div>
      </form>

      <div id="loading" class="loading" style="display: none">
        Loading results...
      </div>
      <div id="error" class="error" style="display: none"></div>
      <div id="resultsInfo" class="results-info" style="display: none"></div>

      <div id="results" style="display: none">
        <div class="table-container">
          <table id="resultsTable">
            <thead>
              <tr>
                <th>Timestamp</th>
                <th>Gate Name</th>
                <th>Alarm Count</th>
                <th>Alarm Diff</th>
                <th>Incoming Count</th>
                <th>Incoming Diff</th>
                <th>Outgoing Count</th>
                <th>Outgoing Diff</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <script>
      const scriptName = "{{.ScriptName}}";
      const queryForm = document.getElementById("queryForm");
      const loading = document.getElementById("loading");
      const error = document.getElementById("error");
      const results = document.getElementById("results");
      const resultsInfo = document.getElementById("resultsInfo");
      const resultsTable = document
        .getElementById("resultsTable")
        .getElementsByTagName("tbody")[0];
      const downloadCsv = document.getElementById("downloadCsv");

      let currentQueryData = null;
      let monthlyChart = null;

      // Load monthly chart and recent stats on page load
      loadMonthlyChart();
      loadRecentStats();

      // Set default dates
      const today = new Date();
      const thirtyDaysAgo = new Date(today.getTime() - (30 * 24 * 60 * 60 * 1000));
      
      document.getElementById("start_date").value = thirtyDaysAgo.toISOString().split('T')[0];
      document.getElementById("end_date").value = today.toISOString().split('T')[0];

      queryForm.addEventListener("submit", async (e) => {
        e.preventDefault();

        const startDate = document.getElementById("start_date").value;
        const endDate = document.getElementById("end_date").value;

        // Validate dates
        if (startDate && endDate && new Date(startDate) >= new Date(endDate)) {
          showError("End date must be after start date");
          return;
        }

        const formData = {
          gate_name: document.getElementById("gate_name").value,
          start_date: startDate,
          end_date: endDate,
          order_by: document.getElementById("order_by").value,
        };

        currentQueryData = formData;

        loading.style.display = "block";
        error.style.display = "none";
        results.style.display = "none";
        resultsInfo.style.display = "none";
        downloadCsv.disabled = true;

        try {
          const response = await fetch(scriptName + "/query", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(formData),
          });

          const data = await response.json();

          if (data.success) {
            displayResults(data.data, data.count);
          } else {
            showError(data.error);
          }
        } catch (err) {
          showError("Network error: " + err.message);
        } finally {
          loading.style.display = "none";
        }
      });

      downloadCsv.addEventListener("click", async () => {
        if (!currentQueryData) return;

        try {
          const response = await fetch(scriptName + "/download_csv", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(currentQueryData),
          });

          if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            const filename =
              response.headers
                .get("Content-Disposition")
                ?.split("filename=")[1] || "gate_counts.csv";
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
          } else {
            showError("Failed to download CSV");
          }
        } catch (err) {
          showError("Download error: " + err.message);
        }
      });

      function displayResults(data, count) {
        resultsTable.innerHTML = "";
        resultsInfo.textContent = "Found " + count + " records";
        resultsInfo.style.display = "block";

        data.forEach((row) => {
          const tr = document.createElement("tr");
          const formattedTimestamp = formatTimestamp(row.timestamp);
          tr.innerHTML =
            "<td>" +
            formattedTimestamp +
            "</td><td>" +
            row.gate_name +
            "</td><td>" +
            row.alarm_count +
            "</td><td>" +
            row.alarm_diff +
            "</td><td>" +
            row.incoming_patrons_count +
            "</td><td>" +
            row.incoming_diff +
            "</td><td>" +
            row.outgoing_patrons_count +
            "</td><td>" +
            row.outgoing_diff +
            "</td>";
          resultsTable.appendChild(tr);
        });

        results.style.display = "block";
        downloadCsv.disabled = false;
      }

      async function loadMonthlyChart() {
        try {
          const response = await fetch(scriptName + "/monthly_stats");
          const data = await response.json();
          
          if (data.success && data.data) {
            renderChart(data.data);
          } else {
            console.error('Failed to load monthly stats:', data.error);
          }
        } catch (err) {
          console.error('Error loading monthly chart:', err);
        }
      }

      function renderChart(monthlyData) {
        const ctx = document.getElementById('monthlyChart').getContext('2d');
        
        // Format month labels to be more readable (e.g., "2024-09" becomes "Sep 2024")
        const labels = monthlyData.map(item => {
          const [year, month] = item.month.split('-');
          const date = new Date(year, month - 1);
          return date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
        });
        
        const entrances = monthlyData.map(item => item.entrances);
        
        if (monthlyChart) {
          monthlyChart.destroy();
        }
        
        monthlyChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: labels,
            datasets: [{
              label: 'Monthly Entrances',
              data: entrances,
              borderColor: '#007bff',
              backgroundColor: 'rgba(0, 123, 255, 0.1)',
              borderWidth: 2,
              fill: true,
              tension: 0.1
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  callback: function(value) {
                    return value.toLocaleString();
                  }
                }
              }
            },
            plugins: {
              tooltip: {
                callbacks: {
                  label: function(context) {
                    return 'Entrances: ' + context.parsed.y.toLocaleString();
                  }
                }
              }
            }
          }
        });
      }

      async function loadRecentStats() {
        try {
          const response = await fetch(scriptName + "/recent_stats");
          const data = await response.json();
          
          if (data.success && data.data) {
            updateRecentStats(data.data);
          } else {
            console.error('Failed to load recent stats:', data.error);
            document.getElementById('entrancesCount').textContent = 'Error';
            document.getElementById('exitsCount').textContent = 'Error';
          }
        } catch (err) {
          console.error('Error loading recent stats:', err);
          document.getElementById('entrancesCount').textContent = 'Error';
          document.getElementById('exitsCount').textContent = 'Error';
        }
      }

      function updateRecentStats(stats) {
        document.getElementById('entrancesCount').textContent = stats.total_entrances.toLocaleString();
        document.getElementById('exitsCount').textContent = stats.total_exits.toLocaleString();
      }

      function formatTimestamp(timestamp) {
        const date = new Date(timestamp);
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        let hours = date.getHours();
        const ampm = hours >= 12 ? 'pm' : 'am';
        hours = hours % 12;
        hours = hours ? hours : 12; // the hour '0' should be '12'
        const hoursStr = String(hours).padStart(2, '0');
        
        return `${year}-${month}-${day} ${hoursStr}:00${ampm}`;
      }

      function showError(message) {
        error.textContent = message;
        error.style.display = "block";
      }
    </script>
  </body>
</html>
